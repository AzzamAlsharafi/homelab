services:
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    restart: unless-stopped
    networks:
      - proxy
    environment:
      TZ: "Asia/Kuala_Lumpur"
      # OAuth2 Proxy configuration
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      OAUTH2_PROXY_REVERSE_PROXY: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_UPSTREAMS: "static://202"
      
      # OIDC Provider (Zitadel)
      OAUTH2_PROXY_PROVIDER: "oidc"
      OAUTH2_PROXY_SCOPE: "openid email profile groups"
      OAUTH2_PROXY_PROVIDER_DISPLAY_NAME: "Zitadel"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "https://auth.home.alsharafi.dev"
      OAUTH2_PROXY_CODE_CHALLENGE_METHOD: "S256"
      OAUTH2_PROXY_CLIENT_ID: "${OAUTH2_PROXY_CLIENT_ID}"
      OAUTH2_PROXY_CLIENT_SECRET: "${OAUTH2_PROXY_CLIENT_SECRET}"
      OAUTH2_PROXY_REDIRECT_URL: "https://oauth2.home.alsharafi.dev/oauth2/callback"
      
      # Cookie settings
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_SECRET: "${OAUTH2_PROXY_COOKIE_SECRET}"
      OAUTH2_PROXY_COOKIE_DOMAINS: ".home.alsharafi.dev"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_HTTPONLY: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: "lax"
      OAUTH2_PROXY_COOKIE_EXPIRE: "1h"  # 1 hour
      OAUTH2_PROXY_COOKIE_REFRESH: "5m" # 5 minutes
      
      # Security
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_WHITELIST_DOMAINS: ".home.alsharafi.dev"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      
      # Restrict access to home group
      OAUTH2_PROXY_OIDC_GROUPS_CLAIM: "groups"
      OAUTH2_PROXY_ALLOWED_GROUPS: "home"
      
      # Logging
      OAUTH2_PROXY_REQUEST_LOGGING: "true"
      OAUTH2_PROXY_STANDARD_LOGGING: "true"
      
    labels:
      # Enable Traefik
      - "traefik.enable=true"
      - "traefik.http.routers.oauth2-proxy.rule=Host(`oauth2.home.alsharafi.dev`)"
      - "traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180"

networks:
  proxy:
    external: true